<!doctype html>
<html>
  <head>
    <title>IndexedDB Test</title>
  </head>
  <body>
    <h1>IndexedDB Test</h1>
    <button onclick="testDB()">Test IndexedDB</button>
    <div id="result"></div>

    <script>
      const DB_NAME = "PixelPlanDB";
      const DB_VERSION = 1;
      const STORES = {
        TASKS: "tasks",
        CATEGORIES: "categories",
        CUSTOM_ICONS: "customIcons",
        ATTRIBUTIONS: "attributions",
        SETTINGS: "settings",
      };

      const initDB = () => {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(DB_NAME, DB_VERSION);

          request.onerror = () => reject(request.error);
          request.onsuccess = () => resolve(request.result);

          request.onupgradeneeded = (event) => {
            const db = event.target.result;

            Object.values(STORES).forEach((storeName) => {
              if (!db.objectStoreNames.contains(storeName)) {
                db.createObjectStore(storeName, { keyPath: "id" });
              }
            });
          };
        });
      };

      const saveToIDB = async (storeName, data) => {
        try {
          const db = await initDB();
          const transaction = db.transaction([storeName], "readwrite");
          const store = transaction.objectStore(storeName);

          await store.put({ id: "data", value: data });
          return true;
        } catch (error) {
          console.error(`Error saving to ${storeName}:`, error);
          return false;
        }
      };

      const loadFromIDB = async (storeName, defaultValue = null) => {
        try {
          const db = await initDB();
          const transaction = db.transaction([storeName], "readonly");
          const store = transaction.objectStore(storeName);

          return new Promise((resolve, reject) => {
            const request = store.get("data");
            request.onsuccess = () => {
              const result = request.result;
              resolve(result ? result.value : defaultValue);
            };
            request.onerror = () => reject(request.error);
          });
        } catch (error) {
          console.error(`Error loading from ${storeName}:`, error);
          return defaultValue;
        }
      };

      async function testDB() {
        const resultDiv = document.getElementById("result");
        try {
          // Test saving data
          const testData = ["test task 1", "test task 2"];
          const saved = await saveToIDB(STORES.TASKS, testData);

          if (saved) {
            // Test loading data
            const loaded = await loadFromIDB(STORES.TASKS, []);

            if (JSON.stringify(loaded) === JSON.stringify(testData)) {
              resultDiv.innerHTML =
                '<p style="color: green;">✅ IndexedDB is working correctly!</p>';
            } else {
              resultDiv.innerHTML =
                '<p style="color: red;">❌ Data mismatch: ' +
                JSON.stringify(loaded) +
                "</p>";
            }
          } else {
            resultDiv.innerHTML =
              '<p style="color: red;">❌ Failed to save data</p>';
          }
        } catch (error) {
          resultDiv.innerHTML =
            '<p style="color: red;">❌ Error: ' + error.message + "</p>";
        }
      }
    </script>
  </body>
</html>
